<div style="max-width:600px;margin:2rem auto;">
  <div class="card">
    <h2 style="text-align:center;margin-bottom:1.5rem;">Edit Event</h2>
    <form action="/events/<%= event ? event._id : '' %>?_method=PUT" method="POST" enctype="multipart/form-data">
      <input type="text" name="title" placeholder="Event Title" value="<%= event ? event.title : '' %>" required>
      <textarea name="description" placeholder="Description" rows="4" required id="textarea"><%= event ? event.description : '' %></textarea>
      <button type="button" class="btn" style="margin-bottom: 1rem;" id="improvise-btn">Improvise</button>
      <input type="text" name="location" placeholder="Location" value="<%= event ? event.location : '' %>" required>
      <input type="date" name="date" value="<%= event ? event.date : '' %>" required>
      <input type="time" name="time" value="<%= event ? event.time : '' %>" required>
      <select name="category" required style="padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); background: white; width: 100%;">
        <option value="">Select Category</option>
        <option value="Technology" <%= event && event.category === 'Technology' ? 'selected' : '' %>>Technology</option>
        <option value="Business" <%= event && event.category === 'Business' ? 'selected' : '' %>>Business</option>
        <option value="Education" <%= event && event.category === 'Education' ? 'selected' : '' %>>Education</option>
        <option value="Entertainment" <%= event && event.category === 'Entertainment' ? 'selected' : '' %>>Entertainment</option>
        <option value="Sports" <%= event && event.category === 'Sports' ? 'selected' : '' %>>Sports</option>
        <option value="Other" <%= event && event.category === 'Other' ? 'selected' : '' %>>Other</option>
      </select>
      <input type="number" name="price" placeholder="Price (USD)" min="0" step="0.01" value="<%= event ? event.price : '' %>">
      <input type="number" name="capacity" placeholder="Capacity" min="1" value="<%= event ? event.capacity : '' %>" required>
      <label style="margin-bottom:0.5rem;display:block;">Banner Image (leave blank to keep current)</label>
      <input type="file" name="banner" accept="image/*">
      <button class="btn" type="submit" style="width:100%;margin-top:1rem;">Update Event</button>
    </form>
  </div>
</div>

<script>
  let isloading = false;
  document.getElementById('improvise-btn').addEventListener('click', async () => {
    if (isloading) return;
    isloading = true;
    if(isloading){
      document.getElementById('improvise-btn').innerText = 'Generating...';
      document.getElementById('improvise-btn').disabled = true;
    }

    const descriptionField = document.getElementById('textarea');
    const description = descriptionField.value.trim();
    if (!description) {
      alert('Please enter a basic description to improvise.');
      return;
    }
    try {
      const response = await fetch('/ask-ai/improve', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text: description })
      });
      const data = await response.json();
      // console.log('Backend response:', data); // Debug line
      if (data.error) {
        alert('Error: ' + data.error);
      } else {
        descriptionField.value = data.response;
      }
    } catch (error) {
      console.error('Error:', error);
      alert('An error occurred while improvising the description.');
    }
    finally {
      isloading = false;
      document.getElementById('improvise-btn').innerText = 'Improvise';
      document.getElementById('improvise-btn').disabled = false;
    }
  });
</script>